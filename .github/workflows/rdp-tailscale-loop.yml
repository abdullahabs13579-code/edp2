name: RDP + Tailscale Loop

on:
  workflow_dispatch:
    inputs:
      ts_tailnet:
        description: "Tailscale tailnet email"
        required: true
      ts_api_key:
        description: "Tailscale API key"
        required: true
      ts_authkey:
        description: "Tailscale Auth key"
        required: true
      cycles:
        description: "Number of cycles"
        required: false
        default: "5"

permissions:
  contents: read
  actions: write

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      RDP_USER: mtqmanik
      RDP_PASS: Manik2200@@
      MAIN_RUNTIME_MIN: 300
      BREAK_MIN: 20

    steps:

    - name: Set cycle count
      shell: pwsh
      run: |
        $cycles = [int]"${{ inputs.cycles }}"
        "CYCLES_LEFT=$cycles" | Out-File -Append $env:GITHUB_ENV

    - name: Set hostname
      shell: pwsh
      run: |
        "TS_HOSTNAME=bullet" | Out-File -Append $env:GITHUB_ENV

    - name: Install and Start Tailscale (IP FIXED)
      shell: pwsh
      run: |
        $exe = "$env:ProgramFiles\Tailscale\tailscale.exe"

        if (-not (Test-Path $exe)) {
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile tailscale.msi
          Start-Process msiexec.exe -ArgumentList "/i tailscale.msi /quiet /norestart" -Wait
        }

        Start-Service Tailscale -ErrorAction SilentlyContinue
        Start-Sleep 10

        & $exe logout | Out-Null
        & $exe up --authkey "${{ inputs.ts_authkey }}" --hostname "$env:TS_HOSTNAME" --accept-routes --accept-dns

        Write-Host "Waiting for Tailscale IP..."
        for ($i=0; $i -lt 15; $i++) {
          $ip = & $exe ip -4 | Select-Object -First 1
          if ($ip) { break }
          Start-Sleep 3
        }

        if (-not $ip) {
          Write-Error "❌ Tailscale IP not assigned"
          exit 1
        }

        Write-Host "✅ Tailscale IP: $ip"
        "TS_IP=$ip" | Out-File -Append $env:GITHUB_ENV

    - name: Show Tailscale Status
      shell: pwsh
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" status

    - name: Enable RDP and Create User
      shell: pwsh
      run: |
        $u=$env:RDP_USER
        $p=$env:RDP_PASS
        $sec = ConvertTo-SecureString $p -AsPlainText -Force

        if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
          New-LocalUser -Name $u -Password $sec -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
        } else {
          Set-LocalUser -Name $u -Password $sec
          Enable-LocalUser -Name $u
        }

        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Upgrade pip
      shell: pwsh
      run: |
        python -m pip install --upgrade pip

    - name: Install Python Modules
      shell: pwsh
      run: |
        pip install opencv-python
        pip install uiautomator2
        pip install playwright
        pip install customtkinter
        python -m playwright install

    - name: Install VS Code
      shell: pwsh
      run: |
        winget install --id Microsoft.VisualStudioCode -e --silent `
        --accept-package-agreements --accept-source-agreements

    - name: Keep session alive (5 hours)
      shell: pwsh
      run: |
        $end = (Get-Date).AddMinutes($env:MAIN_RUNTIME_MIN)
        while ((Get-Date) -lt $end) {
          Start-Sleep 60
        }

    - name: Break (20 minutes)
      if: env.CYCLES_LEFT != '1'
      shell: pwsh
      run: |
        $end = (Get-Date).AddMinutes($env:BREAK_MIN)
        while ((Get-Date) -lt $end) {
          Start-Sleep 60
        }

    - name: Dispatch Next Cycle
      if: env.CYCLES_LEFT != '1'
      shell: pwsh
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        $next = [int]$env:CYCLES_LEFT - 1

        $body = @{
          ref = "${{ github.ref_name }}"
          inputs = @{
            ts_tailnet = "${{ inputs.ts_tailnet }}"
            ts_api_key = "${{ inputs.ts_api_key }}"
            ts_authkey = "${{ inputs.ts_authkey }}"
            cycles = "$next"
          }
        } | ConvertTo-Json -Depth 5

        Invoke-WebRequest -Method POST `
          -Uri "https://api.github.com/repos/${{ github.repository }}/actions/workflows/rdp-tailscale-loop.yml/dispatches" `
          -Headers @{Authorization="Bearer $env:GH_TOKEN"} `
          -Body $body

    - name: Completed
      if: env.CYCLES_LEFT == '1'
      shell: pwsh
      run: |
        Write-Host "✅ All cycles completed"
        Write-Host "RDP IP: $env:TS_IP"
